name: Update Maltrail Ruleset

on:
  schedule:
    # æ¯å¤©å›½é™…æ ‡å‡†æ—¶é—´ 04:00 (åŒ—äº¬æ—¶é—´ 12:00) æ‰§è¡Œ
    - cron: '0 4 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æœ‰å†™æƒé™æ‰èƒ½æ¨é€åˆ°åˆ†æ”¯

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Install sing-box
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬å·
          VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | jq -r .tag_name)
          echo "Installing sing-box $VERSION"
          # ä¸‹è½½å¹¶è§£å‹ (Linux amd64)
          curl -sLo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/${VERSION}/sing-box-${VERSION#v}-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz
          # ç§»åŠ¨äºŒè¿›åˆ¶æ–‡ä»¶åˆ° path
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sing-box version

      - name: Download and Compile Rules
        run: |
          # --- é…ç½® ---
          IP_URL="https://raw.githubusercontent.com/stamparm/ipsum/refs/heads/master/levels/1.txt"
          DOMAIN_URL="https://raw.githubusercontent.com/stamparm/aux/master/maltrail-malware-domains.txt"
          
          # åˆ›å»ºå‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶å¤¹
          # dist-text ç”¨äºå­˜æ”¾ text åˆ†æ”¯çš„å†…å®¹
          # dist-srs  ç”¨äºå­˜æ”¾ rule-set åˆ†æ”¯çš„å†…å®¹
          mkdir -p dist-text
          mkdir -p dist-srs
          
          # å®šä¹‰æ–‡ä»¶è·¯å¾„
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŠŠä¸‹è½½çš„æ–‡ä»¶å­˜åˆ° dist-text ç›®å½•ä¸­ï¼Œå¹¶é‡å‘½åä¸ºå‹å¥½çš„åå­—
          IP_TXT="dist-text/maltrail_ip.txt"
          DOMAIN_TXT="dist-text/maltrail_domain.txt"
          
          # JSON ä¸´æ—¶æ–‡ä»¶ (ä¸éœ€è¦ä¿ç•™ï¼Œæ”¾åœ¨æ ¹ç›®å½•å³å¯)
          IP_JSON="maltrail_ip.json"
          DOMAIN_JSON="maltrail_domain.json"
          
          # --- 1. ä¸‹è½½åˆ—è¡¨ ---
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ IP åˆ—è¡¨..."
          curl -sSL -o "$IP_TXT" "$IP_URL"
          
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½åŸŸååˆ—è¡¨..."
          curl -sSL -o "$DOMAIN_TXT" "$DOMAIN_URL"
          
          # --- 2. å¤„ç† IP ä¸º JSON ---
          echo "ğŸ”„ å¤„ç† IP åˆ—è¡¨..."
          # é€»è¾‘ï¼šè¯»å–æ–‡æœ¬ -> è¿‡æ»¤ç©ºè¡Œ -> å°è£…è¿› sing-box ç»“æ„
          jq -R . "$IP_TXT" | jq -s 'map(select(length > 0))' | jq '{
            "version": 2,
            "rules": [
              {
                "ip_cidr": .
              }
            ]
          }' > "$IP_JSON"
          
          # --- 3. å¤„ç†åŸŸåä¸º JSON ---
          echo "ğŸ”„ å¤„ç†åŸŸååˆ—è¡¨..."
          jq -R . "$DOMAIN_TXT" | jq -s 'map(select(length > 0))' | jq '{
            "version": 2,
            "rules": [
              {
                "domain_suffix": .
              }
            ]
          }' > "$DOMAIN_JSON"
          
          # --- 4. ç¼–è¯‘ä¸º SRS æ–‡ä»¶ ---
          # ç¼–è¯‘ç»“æœç›´æ¥è¾“å‡ºåˆ° dist-srs ç›®å½•
          echo "ğŸ”¨ æ­£åœ¨ç¼–è¯‘ .srs æ–‡ä»¶..."
          sing-box rule-set compile "$IP_JSON" -o dist-srs/maltrail_ip.srs
          sing-box rule-set compile "$DOMAIN_JSON" -o dist-srs/maltrail_domain.srs
          
          # --- 5. æ¸…ç† JSON ä¸´æ—¶æ–‡ä»¶ ---
          # TXT æ–‡ä»¶ä¸æ¸…ç†ï¼Œå› ä¸ºè¦æ¨é€åˆ° text åˆ†æ”¯
          echo "ğŸ§¹ æ¸…ç† JSON..."
          rm "$IP_JSON" "$DOMAIN_JSON"
          
          echo "âœ… å¤„ç†å®Œæˆã€‚"
          echo "ğŸ“‚ dist-text ç›®å½•å†…å®¹ (å°†æ¨é€è‡³ text åˆ†æ”¯):"
          ls -lh dist-text/
          echo "ğŸ“‚ dist-srs ç›®å½•å†…å®¹ (å°†æ¨é€è‡³ rule-set åˆ†æ”¯):"
          ls -lh dist-srs/
      
      # è·å–å½“å‰æ—¥æœŸ
      - name: Get Current Date
        id: info
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # æ¨é€ text åˆ†æ”¯
      - name: Deploy Raw Text to 'text' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist-text
          publish_branch: text
          enable_jekyll: true
          commit_message: "Github Action: update raw text lists [${{ steps.info.outputs.DATE }}]"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      # æ¨é€ rule-set åˆ†æ”¯
      - name: Deploy SRS to 'rule-set' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist-srs
          publish_branch: rule-set
          enable_jekyll: true
          commit_message: "Github Action: update compiled srs ruleset [${{ steps.info.outputs.DATE }}]"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'